import { Request, Response, NextFunction } from 'express';import { verifyToken } from '@/services/auth.service';import { findUserById } from '@/repositories/user.repository';import { errorResponse, StatusCode } from '@/utils/response';import { User } from '@prisma/client';declare global {  namespace Express {    interface Request {      user?: User;    }  }}export const authMiddleware = async (  req: Request,  res: Response,  next: NextFunction): Promise<void | Response> => {  try {    const authHeader = req.headers.authorization;    if (!authHeader) {      return errorResponse(        res,        '未提供认证信息',        StatusCode.UNAUTHORIZED,        401      );    }    const parts = authHeader.split(' ');    if (parts.length !== 2 || parts[0] !== 'Bearer') {      return errorResponse(        res,        '认证信息格式错误',        StatusCode.TOKEN_INVALID,        401      );    }    const token = parts[1];    const payload = verifyToken(token);    const userId = payload.userId;    const user = await findUserById(userId);    if (!user) {      return errorResponse(        res,        '用户不存在',        StatusCode.USER_NOT_FOUND,        401      );    }    req.user = user;    next();  } catch (error) {    console.error('❌ JWT 认证失败:', error);    const errorMessage = error instanceof Error ? error.message : 'Token 验证失败';    if (errorMessage.includes('过期')) {      return errorResponse(        res,        errorMessage,        StatusCode.TOKEN_EXPIRED,        401      );    } else if (errorMessage.includes('无效')) {      return errorResponse(        res,        errorMessage,        StatusCode.TOKEN_INVALID,        401      );    } else {      return errorResponse(        res,        'Token 验证失败',        StatusCode.UNAUTHORIZED,        401      );    }  }};export const optionalAuthMiddleware = async (  req: Request,  res: Response,  next: NextFunction): Promise<void> => {  try {    const authHeader = req.headers.authorization;    if (!authHeader) {      return next();    }    const parts = authHeader.split(' ');    if (parts.length !== 2 || parts[0] !== 'Bearer') {      return next();    }    const token = parts[1];    const payload = verifyToken(token);    const user = await findUserById(payload.userId);    if (user) {      req.user = user;    }    next();  } catch (error) {    console.warn('⚠️  可选认证失败:', error);    next();  }};
