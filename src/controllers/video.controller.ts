import { Request, Response } from 'express';import {  getUploadToken,  createVideo,  getVideoList,  getVideoDetail,  updateVideoInfo,  deleteVideoById,  publishVideoById,  getUserVideos,} from '@/services/video.service';import {  successResponse,  errorResponse,  paginationResponse,  StatusCode,} from '@/utils/response';import { VideoStatus } from '@prisma/client';export const getUploadTokenHandler = async (  req: Request,  res: Response): Promise<Response> => {  try {    const user = (req as any).user;    if (!user) {      return errorResponse(        res,        '用户信息获取失败',        StatusCode.UNAUTHORIZED      );    }    const fileType = (req.query.type as string) || 'video';    if (fileType !== 'video' && fileType !== 'image') {      return errorResponse(        res,        '文件类型只能是 video 或 image',        StatusCode.INVALID_PARAMS      );    }    const uploadToken = getUploadToken(user.id.toString(), fileType);    return successResponse(      res,      uploadToken,      '获取上传凭证成功'    );  } catch (error) {    console.error('❌ 获取上传凭证失败:', error);    return errorResponse(      res,      error instanceof Error ? error.message : '获取上传凭证失败',      StatusCode.OSS_ERROR    );  }};export const createVideoHandler = async (  req: Request,  res: Response): Promise<Response> => {  try {    const user = (req as any).user;    if (!user) {      return errorResponse(        res,        '用户信息获取失败',        StatusCode.UNAUTHORIZED      );    }    const { title, description, coverUrl, videoUrl, duration } = req.body;    if (!title || !coverUrl || !videoUrl || !duration) {      return errorResponse(        res,        '标题、封面、视频地址和时长不能为空',        StatusCode.MISSING_PARAMS      );    }    const video = await createVideo(user.id.toString(), {      title,      description,      coverUrl,      videoUrl,      duration: parseInt(duration),    });    return successResponse(      res,      {        id: video.id.toString(),        title: video.title,        description: video.description,        coverUrl: video.coverUrl,        videoUrl: video.videoUrl,        duration: video.duration,        status: video.status,        author: {          id: video.author.id.toString(),          nickname: video.author.nickname,          avatar: video.author.avatar,        },        createdAt: video.createdAt,        updatedAt: video.updatedAt,      },      '视频创建成功'    );  } catch (error) {    console.error('❌ 创建视频失败:', error);    const errorMessage = error instanceof Error ? error.message : '创建视频失败';    return errorResponse(      res,      errorMessage,      StatusCode.SERVER_ERROR    );  }};export const getVideoListHandler = async (  req: Request,  res: Response): Promise<Response> => {  try {    const page = parseInt(req.query.page as string) || 1;    const limit = parseInt(req.query.limit as string) || 20;    const authorId = req.query.authorId as string;    const status = req.query.status as VideoStatus;    const result = await getVideoList({      page,      limit,      authorId,      status: status || VideoStatus.PUBLISHED,     });    const formattedVideos = result.videos.map((video) => ({      id: video.id.toString(),      title: video.title,      description: video.description,      coverUrl: video.coverUrl,      videoUrl: video.videoUrl,      duration: video.duration,      status: video.status,      author: {        id: video.author.id.toString(),        nickname: video.author.nickname,        avatar: video.author.avatar,      },      createdAt: video.createdAt,      updatedAt: video.updatedAt,    }));    return paginationResponse(      res,      formattedVideos,      result.total,      result.page,      result.limit    );  } catch (error) {    console.error('❌ 获取视频列表失败:', error);    return errorResponse(      res,      error instanceof Error ? error.message : '获取视频列表失败',      StatusCode.SERVER_ERROR    );  }};export const getVideoDetailHandler = async (  req: Request,  res: Response): Promise<Response> => {  try {    const videoId = req.params.id;    if (!videoId) {      return errorResponse(        res,        '视频 ID 不能为空',        StatusCode.MISSING_PARAMS      );    }    const video = await getVideoDetail(videoId);    if (video.status === VideoStatus.BLOCKED) {      const user = (req as any).user;      const isAuthor = user && user.id.toString() === video.author.id.toString();      if (!isAuthor) {        return errorResponse(          res,          '该视频已被屏蔽',          StatusCode.VIDEO_NOT_FOUND        );      }    }    return successResponse(      res,      {        id: video.id.toString(),        title: video.title,        description: video.description,        coverUrl: video.coverUrl,        videoUrl: video.videoUrl,        duration: video.duration,        status: video.status,        author: {          id: video.author.id.toString(),          nickname: video.author.nickname,          avatar: video.author.avatar,        },        createdAt: video.createdAt,        updatedAt: video.updatedAt,      },      '获取成功'    );  } catch (error) {    console.error('❌ 获取视频详情失败:', error);    const errorMessage = error instanceof Error ? error.message : '获取视频详情失败';    if (errorMessage.includes('不存在')) {      return errorResponse(        res,        errorMessage,        StatusCode.VIDEO_NOT_FOUND      );    }    return errorResponse(      res,      errorMessage,      StatusCode.SERVER_ERROR    );  }};export const updateVideoHandler = async (  req: Request,  res: Response): Promise<Response> => {  try {    const user = (req as any).user;    if (!user) {      return errorResponse(        res,        '用户信息获取失败',        StatusCode.UNAUTHORIZED      );    }    const videoId = req.params.id;    const { title, description, coverUrl, videoUrl, duration } = req.body;    const video = await updateVideoInfo(videoId, user.id.toString(), {      title,      description,      coverUrl,      videoUrl,      duration: duration ? parseInt(duration) : undefined,    });    return successResponse(      res,      {        id: video.id.toString(),        title: video.title,        description: video.description,        coverUrl: video.coverUrl,        videoUrl: video.videoUrl,        duration: video.duration,        status: video.status,        updatedAt: video.updatedAt,      },      '视频更新成功'    );  } catch (error) {    console.error('❌ 更新视频失败:', error);    const errorMessage = error instanceof Error ? error.message : '更新视频失败';    if (errorMessage.includes('不存在')) {      return errorResponse(res, errorMessage, StatusCode.VIDEO_NOT_FOUND);    } else if (errorMessage.includes('无权限')) {      return errorResponse(res, errorMessage, StatusCode.UNAUTHORIZED);    }    return errorResponse(res, errorMessage, StatusCode.SERVER_ERROR);  }};export const deleteVideoHandler = async (  req: Request,  res: Response): Promise<Response> => {  try {    const user = (req as any).user;    if (!user) {      return errorResponse(        res,        '用户信息获取失败',        StatusCode.UNAUTHORIZED      );    }    const videoId = req.params.id;    await deleteVideoById(videoId, user.id.toString());    return successResponse(res, null, '视频删除成功');  } catch (error) {    console.error('❌ 删除视频失败:', error);    const errorMessage = error instanceof Error ? error.message : '删除视频失败';    if (errorMessage.includes('不存在')) {      return errorResponse(res, errorMessage, StatusCode.VIDEO_NOT_FOUND);    } else if (errorMessage.includes('无权限')) {      return errorResponse(res, errorMessage, StatusCode.UNAUTHORIZED);    }    return errorResponse(res, errorMessage, StatusCode.SERVER_ERROR);  }};export const publishVideoHandler = async (  req: Request,  res: Response): Promise<Response> => {  try {    const user = (req as any).user;    if (!user) {      return errorResponse(        res,        '用户信息获取失败',        StatusCode.UNAUTHORIZED      );    }    const videoId = req.params.id;    const video = await publishVideoById(videoId, user.id.toString());    return successResponse(      res,      {        id: video.id.toString(),        status: video.status,        updatedAt: video.updatedAt,      },      '视频发布成功'    );  } catch (error) {    console.error('❌ 发布视频失败:', error);    const errorMessage = error instanceof Error ? error.message : '发布视频失败';    if (errorMessage.includes('不存在')) {      return errorResponse(res, errorMessage, StatusCode.VIDEO_NOT_FOUND);    } else if (errorMessage.includes('无权限')) {      return errorResponse(res, errorMessage, StatusCode.UNAUTHORIZED);    }    return errorResponse(res, errorMessage, StatusCode.SERVER_ERROR);  }};export const getUserVideosHandler = async (  req: Request,  res: Response): Promise<Response> => {  try {    const userId = req.params.userId;    const page = parseInt(req.query.page as string) || 1;    const limit = parseInt(req.query.limit as string) || 20;    const result = await getUserVideos(userId, page, limit);    const formattedVideos = result.videos.map((video) => ({      id: video.id.toString(),      title: video.title,      description: video.description,      coverUrl: video.coverUrl,      videoUrl: video.videoUrl,      duration: video.duration,      status: video.status,      author: {        id: video.author.id.toString(),        nickname: video.author.nickname,        avatar: video.author.avatar,      },      createdAt: video.createdAt,    }));    return paginationResponse(      res,      formattedVideos,      result.total,      result.page,      result.limit    );  } catch (error) {    console.error('❌ 获取用户视频列表失败:', error);    return errorResponse(      res,      error instanceof Error ? error.message : '获取用户视频列表失败',      StatusCode.SERVER_ERROR    );  }};
