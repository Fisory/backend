import { generateOSSUploadSignature, OSSUploadSignature } from '@/services/oss.service';import {  createVideo as createVideoRepo,  findVideoById,  findVideos,  findVideosByAuthor,  updateVideo,  deleteVideo,  publishVideo,  blockVideo,  VideoWithAuthor,} from '@/repositories/video.repository';import { VideoStatus } from '@prisma/client';export interface CreateVideoRequest {  title: string;  description?: string;  coverUrl: string;  videoUrl: string;  duration: number;}export interface UpdateVideoRequest {  title?: string;  description?: string;  coverUrl?: string;  videoUrl?: string;  duration?: number;}export interface VideoListQuery {  page?: number;  limit?: number;  authorId?: string | number;  status?: VideoStatus;}export const getUploadToken = (  userId: string | number,  fileType: 'video' | 'image' = 'video'): OSSUploadSignature => {  return generateOSSUploadSignature(userId, fileType);};export const createVideo = async (  userId: string | number,  data: CreateVideoRequest): Promise<VideoWithAuthor> => {  if (!data.title || data.title.trim().length === 0) {    throw new Error('视频标题不能为空');  }  if (data.title.length > 200) {    throw new Error('视频标题不能超过 200 个字符');  }  if (!data.videoUrl || !data.coverUrl) {    throw new Error('视频地址和封面地址不能为空');  }  if (!data.duration || data.duration <= 0) {    throw new Error('视频时长必须大于 0');  }  const video = await createVideoRepo({    title: data.title.trim(),    description: data.description?.trim(),    coverUrl: data.coverUrl,    videoUrl: data.videoUrl,    duration: data.duration,    authorId: userId,    status: VideoStatus.DRAFT,   });  const videoWithAuthor = await findVideoById(video.id, true);  if (!videoWithAuthor) {    throw new Error('视频创建失败');  }  return videoWithAuthor as VideoWithAuthor;};export const getVideoList = async (  query: VideoListQuery = {}): Promise<{  videos: VideoWithAuthor[];  total: number;  page: number;  limit: number;  totalPages: number;}> => {  const {    page = 1,    limit = 20,    authorId,    status,  } = query;  const safeLimit = Math.min(limit, 100);  const { videos, total } = await findVideos({    authorId,    status,    page,    limit: safeLimit,    orderBy: 'createdAt',    order: 'desc',  });  const totalPages = Math.ceil(total / safeLimit);  return {    videos,    total,    page,    limit: safeLimit,    totalPages,  };};export const getVideoDetail = async (  videoId: string | number): Promise<VideoWithAuthor> => {  const video = await findVideoById(videoId, true);  if (!video) {    throw new Error('视频不存在');  }  return video as VideoWithAuthor;};export const updateVideoInfo = async (  videoId: string | number,  userId: string | number,  data: UpdateVideoRequest): Promise<VideoWithAuthor> => {  const video = await findVideoById(videoId, false);  if (!video) {    throw new Error('视频不存在');  }  const userIdBigInt = typeof userId === 'bigint' ? userId : BigInt(userId);  if (video.authorId !== userIdBigInt) {    throw new Error('无权限修改此视频');  }  if (data.title !== undefined) {    if (data.title.trim().length === 0) {      throw new Error('视频标题不能为空');    }    if (data.title.length > 200) {      throw new Error('视频标题不能超过 200 个字符');    }  }  if (data.duration !== undefined && data.duration <= 0) {    throw new Error('视频时长必须大于 0');  }  await updateVideo(videoId, {    title: data.title?.trim(),    description: data.description?.trim(),    coverUrl: data.coverUrl,    videoUrl: data.videoUrl,    duration: data.duration,  });  const updatedVideo = await findVideoById(videoId, true);  if (!updatedVideo) {    throw new Error('视频更新失败');  }  return updatedVideo as VideoWithAuthor;};export const deleteVideoById = async (  videoId: string | number,  userId: string | number): Promise<void> => {  const video = await findVideoById(videoId, false);  if (!video) {    throw new Error('视频不存在');  }  const userIdBigInt = typeof userId === 'bigint' ? userId : BigInt(userId);  if (video.authorId !== userIdBigInt) {    throw new Error('无权限删除此视频');  }  await deleteVideo(videoId);};export const publishVideoById = async (  videoId: string | number,  userId: string | number): Promise<VideoWithAuthor> => {  const video = await findVideoById(videoId, false);  if (!video) {    throw new Error('视频不存在');  }  const userIdBigInt = typeof userId === 'bigint' ? userId : BigInt(userId);  if (video.authorId !== userIdBigInt) {    throw new Error('无权限发布此视频');  }  if (video.status !== VideoStatus.DRAFT) {    throw new Error('只有草稿状态的视频才能发布');  }  await publishVideo(videoId);  const publishedVideo = await findVideoById(videoId, true);  if (!publishedVideo) {    throw new Error('视频发布失败');  }  return publishedVideo as VideoWithAuthor;};export const getUserVideos = async (  authorId: string | number,  page: number = 1,  limit: number = 20): Promise<{  videos: VideoWithAuthor[];  total: number;  page: number;  limit: number;  totalPages: number;}> => {  const safeLimit = Math.min(limit, 100);  const { videos, total } = await findVideosByAuthor(    authorId,    VideoStatus.PUBLISHED,    page,    safeLimit  );  const totalPages = Math.ceil(total / safeLimit);  return {    videos,    total,    page,    limit: safeLimit,    totalPages,  };};
